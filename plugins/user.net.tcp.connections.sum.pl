#!/usr/bin/perl
# coding: utf-8



#
# 累積接続数を表示します。
#



use strict;
use Getopt::Long;





###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
package out;

# sub new {}

sub println {

	print(@_, "\x0a");
}






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
package current_section;

# sub new {}

our $section = '';









###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
package main;

# sub new {}

sub _analyze_line {

	my ($line) = @_;



	if($line =~ m/\ATcp\:/msi) {
		$current_section::section = 'TCP';
		return;
	}

	if(!('TCP' eq $current_section::section)) {
		return;
	}

	if(index($line, 'passive connection openings') == -1) {
		return;
	}

	my ($connections, undef) = split(' ', $line);

	out::println($connections);
}

sub _analyze {

	my $stream = undef;



	my $command_text = '/bin/netstat --statistics |';
	if(!open($stream, $command_text)) {
		return;
	}

	while(my $line = <$stream>) {
		_analyze_line($line);
	}

	close($stream);
}

sub _usage {

	out::println('usage:');
	out::println('    --help: show this message.');
	out::println('');
}

sub _main {

	my $action_help = 0;
	my $result = Getopt::Long::GetOptions(
		'help!' => \$action_help);
	if(!$result) {
		_usage();
	}
	elsif($action_help) {
		_usage();
	}
	else {
		_analyze();
	}
}

main::_main(@ARGV);
